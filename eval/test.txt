# test_1/main.py
import argparse
import time
from pathlib import Path

from dotenv import load_dotenv
load_dotenv()

import config
from src.processing.json_parser import process_document_json
from src.alignment.semantic_aligner import align_content
from src.reporting.markdown_writer import save_to_markdown
from src.reporting.excel_writer import save_alignment_report, save_evaluation_report
from src.evaluation.pipeline import run_evaluation_pipeline

def main():
    parser = argparse.ArgumentParser(
        description="Aligns and optionally evaluates content from two Azure Document Intelligence JSON files."
    )
    parser.add_argument("english_json", type=str, help="Path to the English JSON file.")
    parser.add_argument("german_json", type=str, help="Path to the German JSON file.")
    parser.add_argument(
        "-o", "--output", type=str, help="Path for the output alignment Excel file.",
        default=None
    )
    parser.add_argument(
        "--evaluate", action="store_true",
        help="Run the AI evaluation pipeline after alignment."
    )
    parser.add_argument(
        "--debug-report", action="store_true",
        help="Generate a detailed alignment report including margin scores."
    )
    parser.add_argument(
        "--context-window", type=int, default=1,
        help="Size of context window (default: 1 for context-aware embeddings, 0 for no context)."
    )
    args = parser.parse_args()

    # --- 1. Setup Paths ---
    eng_path = Path(args.english_json)
    ger_path = Path(args.german_json)

    output_dir = Path(config.OUTPUT_DIR)
    output_dir.mkdir(exist_ok=True)

    timestamp = time.strftime("%Y%m%d_%H%M%S")
    base_name = f"{eng_path.stem}_{timestamp}"

    if args.output:
        output_alignment_path = Path(args.output)
    else:
        output_alignment_path = output_dir / f"alignment_{base_name}.xlsx"

    print("--- Document Alignment Pipeline Started ---")
    print(f"English Source: {eng_path}")
    print(f"German Source:  {ger_path}")
    print(f"Alignment Algorithm: Margin-Based (Best Effort)")
    print(f"Context Window Size: {args.context_window}\n")

    try:
        print("Step 1/4: Processing JSON files...")
        english_content = process_document_json(eng_path)
        german_content = process_document_json(ger_path)
        print(f"-> Extracted {len(english_content)} English segments and {len(german_content)} German segments.\n")
    except FileNotFoundError as e:
        print(f"Error: Input file not found. {e}")
        return
    except Exception as e:
        print(f"An error occurred during JSON processing: {e}")
        return

    print("Step 2/4: Creating verification Markdown files...")
    save_to_markdown(english_content, output_dir / f"{eng_path.stem}_processed.md")
    save_to_markdown(german_content, output_dir / f"{ger_path.stem}_processed.md")
    print(f"-> Markdown files saved in '{output_dir.resolve()}'\n")

    print("Step 3/4: Performing semantic alignment...")
    aligned_pairs = align_content(
        english_content,
        german_content,
        context_window=args.context_window,
    )
    print(f"-> Alignment complete. Found {len(aligned_pairs)} aligned pairs.\n")

    print("Step 4/4: Writing alignment report(s) to Excel...")
    save_alignment_report(aligned_pairs, output_alignment_path)
    print(f"-> Main alignment report saved to: {output_alignment_path.resolve()}")
    
    if args.debug_report:
        debug_report_path = output_dir / f"debug_report_{base_name}.xlsx"
        # The same function now smartly includes the margin score for the debug report
        save_alignment_report(aligned_pairs, debug_report_path)
        print(f"-> Debug report with margin scores saved to: {debug_report_path.resolve()}")
    print("")

    if args.evaluate:
        print("Step 5/4: Running AI evaluation pipeline...")
        try:
            evaluation_results = list(run_evaluation_pipeline(aligned_pairs))

            if not evaluation_results:
                print("-> Evaluation complete. No significant errors were found.")
            else:
                print(f"-> Evaluation complete. Found {len(evaluation_results)} potential errors.")
                output_eval_path = output_dir / f"evaluation_report_{base_name}.xlsx"
                save_evaluation_report(evaluation_results, output_eval_path)
                print(f"-> Evaluation report saved to: {output_eval_path.resolve()}")

        except RuntimeError as e:
            print(f"\nERROR: Could not run evaluation. {e}")
        except Exception as e:
            print(f"\nAn unexpected error occurred during evaluation: {e}")

    print("\n--- Pipeline Finished Successfully ---")

if __name__ == "__main__":
    main()
