// test_1/app.py
# test_1/app.py
from dotenv import load_dotenv
load_dotenv()

import streamlit as st
from datetime import datetime
import time
from pathlib import Path
import os # <-- No longer needed for file cleanup

# --- Import project modules ---
import config
from src.clients.doc_intelligence_client import analyze_pdf
from src.processing.json_parser import process_document_json
# --- FIX for Flaw 3: Import new function and remove old one ---
from src.processing.toc_parser import get_toc_text_from_pdf_bytes, structure_toc
# --- END FIX ---
from src.alignment.toc_aligner import align_tocs
from src.alignment.semantic_aligner import align_content
from src.evaluation.pipeline import run_evaluation_pipeline
from src.reporting.excel_writer import (
Â  Â  create_excel_report_in_memory,
Â  Â  save_alignment_report,
Â  Â  save_evaluation_report,
Â  Â  save_sectionwise_debug_report # Import the new function
)
from src.reporting.markdown_writer import save_to_markdown

# --- FIX for Flaw 3: Remove save_temp_file helper function ---
# (The save_temp_file function is no longer needed)
# --- END FIX ---

# --- Page Configuration & UI Functions (unchanged) ---
st.set_page_config(page_title="Translation Evaluator", layout="wide")

def display_results(results_list: list):
Â  Â  """Renders the list of evaluation findings in the Streamlit UI."""
Â  Â  if not results_list: return
Â  Â  st.subheader(f"Found {len(results_list)} noteworthy items")
Â  Â  results_list.sort(key=lambda x: x.get('page', 0))
Â  Â  for result in results_list:
Â  Â  Â  Â  error_type = result.get('type', 'Info')
Â  Â  Â  Â  with st.container(border=True):
Â  Â  Â  Â  Â  Â  st.markdown(f"**Page:** `{result.get('page', 'N/A')}` | **Type:** `{error_type}`")
Â  Â  Â  Â  Â  Â  original_phrase, translated_phrase = result.get("original_phrase"), result.get("translated_phrase")
Â  Â  Â  Â  Â  Â  if original_phrase or translated_phrase:
Â  Â  Â  Â  Â  Â  Â  Â  st.markdown("##### ðŸ” Error Focus")
Â  Â  Â  Â  Â  Â  Â  Â  col1, col2 = st.columns(2)
Â  Â  Â  Â  Â  Â  Â  Â  with col1:
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  st.markdown("**Original English Phrase:**"); st.error(f"'{original_phrase or 'N/A'}'")
Â  Â  Â  Â  Â  Â  Â  Â  with col2:
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  st.markdown("**Translated German Phrase:**"); st.warning(f"'{translated_phrase or 'N/A'}'")
Â  Â  Â  Â  Â  Â  Â  Â  st.divider()
Â  Â  Â  Â  Â  Â  st.markdown("##### Full Text Context")
Â  Â  Â  Â  Â  Â  col1, col2 = st.columns(2)
Â  Â  Â  Â  Â  Â  with col1: st.markdown(f"> {result['english_text']}")
Â  Â  Â  Â  Â  Â  with col2: st.markdown(f"> {result['german_text']}")
Â  Â  Â  Â  Â  Â  st.markdown(f"**ðŸ’¡ Suggestion:** {result['suggestion']}")

# --- Main App ---
st.title("ðŸ“š Translation Evaluator (ToC-Based)")
st.markdown("This tool aligns documents section-by-section based on the Table of Contents for improved accuracy.")
st.divider()

if 'analysis_complete' not in st.session_state: st.session_state.analysis_complete = False
if 'evaluation_results' not in st.session_state: st.session_state.evaluation_results = []
if 'error_message' not in st.session_state: st.session_state.error_message = None

# --- Sidebar for Inputs and Controls ---
with st.sidebar:
Â  Â  st.header("1. Upload Documents")
Â  Â  english_pdf = st.file_uploader("Upload English PDF (Source)", type="pdf", key="eng_pdf")
Â  Â  german_pdf = st.file_uploader("Upload German PDF (Translation)", type="pdf", key="ger_pdf")

Â  Â  st.header("2. Configure & Run")
Â  Â  toc_page_num = st.number_input("ToC Page Number in PDF", min_value=1, max_value=20, value=2) - 1

Â  Â  if st.button("ðŸš€ Run Analysis", disabled=not (english_pdf and german_pdf), type="primary"):
Â  Â  Â  Â  st.session_state.analysis_complete = False
Â  Â  Â  Â  st.session_state.evaluation_results = []
Â  Â  Â  Â  st.session_state.error_message = None

Â  Â  Â  Â  output_dir = Path(config.OUTPUT_DIR)
Â  Â  Â  Â  output_dir.mkdir(exist_ok=True)
Â  Â  Â  Â  timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
Â  Â  Â  Â  base_filename = f"{Path(english_pdf.name).stem}_{timestamp}"
Â  Â  Â  Â Â 
Â  Â  Â  Â  # --- FIX for Flaw 3: Remove temp file variables ---
Â  Â  Â  Â  # (No longer need eng_temp_path, ger_temp_path)
Â  Â  Â  Â  # --- END FIX ---
Â  Â  Â  Â  try:
Â  Â  Â  Â  Â  Â  final_aligned_pairs = []
Â  Â  Â  Â  Â  Â  section_debug_data = {} # To store data for the debug report

Â  Â  Â  Â  Â  Â  with st.spinner("Step 1/8: Analyzing PDFs with Azure Document Intelligence..."):
                # --- FIX for Flaw 3: Get bytes here ---
Â  Â  Â  Â  Â  Â  Â  Â  eng_pdf_bytes = english_pdf.getvalue()
Â  Â  Â  Â  Â  Â  Â  Â  ger_pdf_bytes = german_pdf.getvalue()
Â  Â  Â  Â  Â  Â  Â  Â  eng_json_data = analyze_pdf(eng_pdf_bytes, english_pdf.name)
Â  Â  Â  Â  Â  Â  Â  Â  ger_json_data = analyze_pdf(ger_pdf_bytes, german_pdf.name)
                # --- END FIX ---

Â  Â  Â  Â  Â  Â  with st.spinner("Step 2/8: Processing full document content..."):
Â  Â  Â  Â  Â  Â  Â  Â  full_english_content = process_document_json(eng_json_data)
Â  Â  Â  Â  Â  Â  Â  Â  full_german_content = process_document_json(ger_json_data)

Â  Â  Â  Â  Â  Â  with st.spinner("Step 3/8: Extracting and structuring Tables of Contents..."):
Â  Â  Â  Â  Â  Â  Â  Â  # --- FIX for Flaw 3: Use bytes directly ---
Â  Â  Â  Â  Â  Â  Â  Â  english_toc = structure_toc(get_toc_text_from_pdf_bytes(eng_pdf_bytes, page_num=toc_page_num))
Â  Â  Â  Â  Â  Â  Â  Â  german_toc = structure_toc(get_toc_text_from_pdf_bytes(ger_pdf_bytes, page_num=toc_page_num))
Â  Â  Â  Â  Â  Â  Â  Â  # --- END FIX ---

Â  Â  Â  Â  Â  Â  with st.spinner("Step 4/8: Aligning ToC sections..."):
Â  Â  Â  Â  Â  Â  Â  Â  aligned_sections = align_tocs(english_toc, german_toc)
Â  Â  Â  Â  Â  Â  Â  Â  st.toast(f"Matched {len(aligned_sections)} ToC sections.")
Â  Â  Â  Â  Â  Â  Â  Â  with st.expander("âœ… Matched Sections", expanded=True):
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  for sec in aligned_sections:
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  st.write(f"'{sec['english']['title']}' â†’ '{sec['german']['title']}'")

Â  Â  Â  Â  Â  Â  with st.spinner("Step 5/8: Aligning content for each section..."):
Â  Â  Â  Â  Â  Â  Â  Â  progress_bar = st.progress(0, "Aligning sections...")
Â  Â  Â  Â  Â  Â  Â  Â  for i, section in enumerate(aligned_sections):
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  eng_sec, ger_sec = section['english'], section['german']

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  eng_section_content = [item for item in full_english_content if eng_sec['start_page'] <= item['page'] <= eng_sec['end_page']]
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ger_section_content = [item for item in full_german_content if ger_sec['start_page'] <= item['page'] <= ger_sec['end_page']]

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if eng_section_content and ger_section_content:
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  aligned_pairs_section = align_content(eng_section_content, ger_section_content, context_window=1)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  final_aligned_pairs.extend(aligned_pairs_section)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  # Store results for debug report
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  section_debug_data[eng_sec['title']] = aligned_pairs_section

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  progress_bar.progress((i + 1) / len(aligned_sections), f"Aligned '{eng_sec['title']}'")
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  with st.spinner("Step 6/8: Saving alignment and debug reports..."):
Â  Â  Â  Â  Â  Â  Â  Â  final_aligned_pairs.sort(key=lambda x: (x['english']['page'] if x.get('english') else float('inf')))
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  alignment_report_path = output_dir / f"alignment_{base_filename}.xlsx"
Â  Â  Â  Â  Â  Â  Â  Â  save_alignment_report(final_aligned_pairs, alignment_report_path)
Â  Â  Â  Â  Â  Â  Â  Â  st.toast("Saved Main Alignment Report.")

Â  Â  Â  Â  Â  Â  Â  Â  debug_report_path = output_dir / f"debug_report_{base_filename}.xlsx"
Â  Â  Â  Â  Â  Â  Â  Â  save_sectionwise_debug_report(section_debug_data, debug_report_path)
Â  Â  Â  Â  Â  Â  Â  Â  st.toast("Saved Section-wise Debug Report.")


Â  Â  Â  Â  Â  Â  with st.spinner("Step 7/8: Evaluating aligned pairs for errors..."):
Â  Â  Â  Â  Â  Â  Â  Â  st.session_state.evaluation_results = list(run_evaluation_pipeline(final_aligned_pairs))

Â  Â  Â  Â  Â  Â  with st.spinner("Step 8/8: Saving evaluation report..."):
Â  Â  Â  Â  Â  Â  Â  Â  if st.session_state.evaluation_results:
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  eval_report_path = output_dir / f"evaluation_{base_filename}.xlsx"
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  save_evaluation_report(st.session_state.evaluation_results, eval_report_path)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  st.toast("Saved Evaluation Report.")

Â  Â  Â  Â  Â  Â  st.session_state.analysis_complete = True
Â  Â  Â  Â  Â  Â  st.success("Analysis pipeline finished successfully!")
Â  Â  Â  Â  Â  Â  time.sleep(2)
Â  Â  Â  Â  Â  Â  st.rerun()

Â  Â  Â  Â  except Exception as e:
Â  Â  Â  Â  Â  Â  # This block will now also catch the RuntimeError from the embedding failure
Â  Â  Â  Â  Â  Â  st.session_state.error_message = f"An error occurred: {e}"
Â  Â  Â  Â  Â  Â  st.exception(e) # Also show traceback in the terminal for debugging
Â  D Â  Â  Â  Â  st.rerun()
Â  Â  Â  Â Â 
Â  Â  Â  Â  # --- FIX for Flaw 3: Remove finally block ---
Â  Â  Â  Â  # (The finally block for os.remove is no longer needed)
Â  Â  Â  Â  # --- END FIX ---


Â  Â  # --- Download Button ---
Â  Â  st.header("3. Export Results")
Â  Â  if st.session_state.analysis_complete and st.session_state.evaluation_results:
Â  Â  Â  Â  excel_data = create_excel_report_in_memory(st.session_state.evaluation_results)
Â  Â  Â  Â  st.download_button(
Â  Â  Â  Â  Â  Â  label="ðŸ“¥ Download Evaluation Report",
Â  Â  Â  Â  Â  Â  data=excel_data,
Â  Â  Â  Â  Â  Â  file_name=f"Translation_Evaluation_{datetime.now().strftime('%Y-%m-%d')}.xlsx",
Â  Â  Â  Â  Â  Â  mime="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",
Â  Â  Â  Â  )
Â  Â  else:
Â  Â  Â  Â  st.markdown("_Report available after analysis._")

# --- Main Display Area ---
st.header("Evaluation Results")

if st.session_state.error_message:
Â  Â  st.error(st.session_state.error_message, icon="ðŸš¨")
elif st.session_state.analysis_complete:
Â  Â  if not st.session_state.evaluation_results:
Â  Â  Â  Â  st.success("âœ… Analysis complete. No significant errors were found.")
Â  Â  else:
Â  Â  Â  Â  display_results(st.session_state.evaluation_results)
else:
Â  Â  st.info("Upload your PDFs and click 'Run Analysis' to begin.")
