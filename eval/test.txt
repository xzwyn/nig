import { useState } from 'react';
import axios from 'axios';
import { PacmanLoader } from 'react-spinners';
import { FaUpload, FaFilePdf, FaTimesCircle, FaDownload, FaCog, FaCheckCircle, FaExclamationCircle } from 'react-icons/fa';
import './App.css';

const API_URL = 'http://localhost:8000';

function App() {
  const [englishFile, setEnglishFile] = useState(null);
  const [germanFile, setGermanFile] = useState(null);
  const [alignmentMode, setAlignmentMode] = useState('ToC-Based');
  const [tocPageNum, setTocPageNum] = useState(2);

  const [isLoading, setIsLoading] = useState(false);
  const [error, setError] = useState(null);
  const [findings, setFindings] = useState([]);
  const [reportBase64, setReportBase64] = useState(null);

  const handleSubmit = async (e) => {
    e.preventDefault();
    if (!englishFile || !germanFile) {
      setError('Please upload both PDF files to proceed.');
      return;
    }

    setIsLoading(true);
    setError(null);
    setFindings([]);
    setReportBase64(null);

    const formData = new FormData();
    formData.append('english_pdf', englishFile);
    formData.append('german_pdf', germanFile);
    formData.append('alignment_mode', alignmentMode);
    formData.append('toc_page_num', tocPageNum);

    try {
      const response = await axios.post(`${API_URL}/analyze`, formData, {
        headers: {
          'Content-Type': 'multipart/form-data',
        },
      });

      setFindings(response.data.findings || []);
      setReportBase64(response.data.report_base64);

    } catch (err) {
      const errorMsg = err.response?.data?.detail || err.message;
      setError(`Analysis Failed: ${errorMsg}. Please check your files and configuration.`);
    } finally {
      setIsLoading(false);
    }
  };

  const handleDownload = () => {
    if (!reportBase64) return;
    const link = document.createElement('a');
    link.href = `data:application/vnd.openxmlformats-officedocument.spreadsheetml.sheet;base64,${reportBase64}`;
    link.download = `Translation_Evaluation_Report_${new Date().toISOString().split('T')[0]}.xlsx`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  };

  return (
    <div className="app-layout">
      {/* Sidebar / Configuration Panel */}
      <aside className="sidebar-panel">
        <div className="sidebar-header">
          <FaCog className="icon-cog" />
          <h1>Evaluation Settings</h1>
        </div>
        <form onSubmit={handleSubmit} className="config-form">
          <FileUploadInput 
            label="Upload English PDF (Source)" 
            file={englishFile} 
            setFile={setEnglishFile} 
          />
          <FileUploadInput 
            label="Upload German PDF (Translation)" 
            file={germanFile} 
            setFile={setGermanFile} 
          />

          <SelectInput
            label="Alignment Mode"
            value={alignmentMode}
            onChange={(e) => setAlignmentMode(e.target.value)}
            options={[
              { value: 'ToC-Based', label: 'ToC-Based Alignment' },
              { value: 'Full Document', label: 'Full Document Alignment' },
            ]}
          />

          {alignmentMode === 'ToC-Based' && (
            <div className="form-group">
              <label htmlFor="tocPageNum">ToC Page Number</label>
              <input
                id="tocPageNum"
                type="number"
                value={tocPageNum}
                onChange={(e) => setTocPageNum(parseInt(e.target.value, 10))}
                min="1"
                step="1"
                className="input-field"
              />
              <p className="help-text">Specify the 1-indexed page number where the Table of Contents starts.</p>
            </div>
          )}

          <button
            type="submit"
            className="btn btn-primary"
            disabled={isLoading || !englishFile || !germanFile}
          >
            {isLoading ? 'üöÄ Analyzing...' : 'üöÄ Run Analysis'}
          </button>
        </form>

        {reportBase64 && !isLoading && (
          <div className="download-section">
            <button onClick={handleDownload} className="btn btn-secondary">
              <FaDownload /> Download Evaluation Report
            </button>
          </div>
        )}
      </aside>

      {/* Main Content Area */}
      <main className="main-content-area">
        <h2>Evaluation Results</h2>

        {isLoading && (
          <div className="status-message loading">
            <PacmanLoader color="#2196F3" size={30} />
            <p>Analyzing documents, this may take a few moments...</p>
          </div>
        )}

        {error && (
          <div className="status-message error">
            <FaExclamationCircle className="status-icon" />
            <h3>Error Occurred</h3>
            <p>{error}</p>
            <p>Please review your inputs and try again.</p>
          </div>
        )}

        {!isLoading && !error && findings.length === 0 && (
          <div className="status-message empty-state">
            <FaFilePdf className="status-icon" />
            <p>Upload your English and German PDF documents, configure settings, and click 'Run Analysis' to see results here.</p>
          </div>
        )}

        {findings.length > 0 && (
          <div className="results-container">
            <h3 className="results-summary">
              <FaCheckCircle className="icon-success" /> Found {findings.length} potential issues or insights.
            </h3>
            {findings.map((finding, index) => (
              <FindingCard key={index} finding={finding} />
            ))}
          </div>
        )}
      </main>
    </div>
  );
}


// --- Reusable File Upload Input Component ---
function FileUploadInput({ label, file, setFile }) {
  const id = label.replace(/\s+/g, '-').toLowerCase(); // Unique ID for label connection

  return (
    <div className="form-group file-upload-group">
      <label htmlFor={id} className="file-upload-label">
        {label}
        <span className="file-upload-btn">
          <FaUpload /> {file ? 'Change File' : 'Browse Files'}
        </span>
      </label>
      <input
        id={id}
        type="file"
        accept="application/pdf"
        onChange={(e) => setFile(e.target.files[0])}
        className="hidden-file-input"
      />
      {file && (
        <div className="file-info">
          <FaFilePdf className="file-icon" />
          <span>{file.name}</span>
          <FaTimesCircle className="remove-file-icon" onClick={() => setFile(null)} />
        </div>
      )}
    </div>
  );
}

// --- Reusable Select Input Component ---
function SelectInput({ label, value, onChange, options }) {
  const id = label.replace(/\s+/g, '-').toLowerCase();
  return (
    <div className="form-group">
      <label htmlFor={id}>{label}</label>
      <div className="custom-select-wrapper">
        <select id={id} value={value} onChange={onChange} className="input-field">
          {options.map((option) => (
            <option key={option.value} value={option.value}>
              {option.label}
            </option>
          ))}
        </select>
        <span className="custom-select-arrow"></span> {/* Custom arrow */}
      </div>
    </div>
  );
}


// --- FindingCard Component (Reused and slightly styled) ---
function FindingCard({ finding }) {
  const { 
    page, 
    type, 
    suggestion, 
    english_text, 
    german_text, 
    original_phrase, 
    translated_phrase 
  } = finding;

  return (
    <div className="finding-card">
      <div className="card-header">
        <span className="card-badge">{type}</span>
        <span className="card-page">Page: {page || 'N/A'}</span>
      </div>
      
      {(original_phrase || translated_phrase) && (
        <div className="card-section error-focus">
          <h4>üîç Key Discrepancy</h4>
          <div className="text-pair">
            <div className="text-block">
              <strong>English Phrase:</strong>
              <p className="highlight-error">{original_phrase || 'N/A'}</p>
            </div>
            <div className="text-block">
              <strong>German Phrase:</strong>
              <p className="highlight-warning">{translated_phrase || 'N/A'}</p>
            </div>
          </div>
        </div>
      )}

      <div className="card-section">
        <h4>Full Context</h4>
        <div className="text-pair">
          <div className="text-block">
            <strong>English Text:</strong>
            <blockquote>{english_text}</blockquote>
          </div>
          <div className="text-block">
            <strong>German Text:</strong>
            <blockquote>{german_text}</blockquote>
          </div>
        </div>
      </div>

      <div className="card-section suggestion-section">
        <strong>üí° Suggestion:</strong> {suggestion}
      </div>
    </div>
  );
}

export default App;







/* General Styling */
:root {
  font-family: 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif;
  --primary-color: #2196F3; /* Blue */
  --secondary-color: #4CAF50; /* Green */
  --accent-color: #FFC107; /* Amber */
  --error-color: #f44336; /* Red */
  --text-color: #333;
  --light-gray: #f8f9fa;
  --medium-gray: #e9ecef;
  --dark-gray: #6c757d;
  --border-color: #dee2e6;
  --shadow-sm: 0 1px 3px rgba(0,0,0,0.08);
  --shadow-md: 0 4px 12px rgba(0,0,0,0.1);
  --border-radius-sm: 4px;
  --border-radius-md: 8px;
}

body {
  margin: 0;
  background-color: var(--light-gray);
  color: var(--text-color);
  line-height: 1.6;
}

h1, h2, h3, h4 {
  color: #1a202c;
  margin-top: 0;
}

/* Layout */
.app-layout {
  display: flex;
  min-height: 100vh;
  flex-direction: column; /* Default for mobile */
}

.sidebar-panel {
  width: 100%; /* Full width on mobile */
  background-color: #ffffff;
  padding: 1.5rem;
  box-shadow: var(--shadow-sm);
  border-bottom: 1px solid var(--border-color);
  display: flex;
  flex-direction: column;
  gap: 1.5rem;
}

.main-content-area {
  flex-grow: 1;
  padding: 1.5rem;
  background-color: var(--light-gray);
}

@media (min-width: 768px) { /* Tablet and Desktop */
  .app-layout {
    flex-direction: row;
  }
  .sidebar-panel {
    width: 380px; /* Fixed width sidebar */
    min-height: 100vh;
    border-right: 1px solid var(--border-color);
    border-bottom: none;
    box-shadow: none;
  }
  .main-content-area {
    padding: 2rem;
  }
}

/* Sidebar Header */
.sidebar-header {
  display: flex;
  align-items: center;
  gap: 0.75rem;
  margin-bottom: 1rem;
}

.sidebar-header h1 {
  font-size: 1.6rem;
  margin: 0;
  font-weight: 600;
}

.icon-cog {
  font-size: 1.8rem;
  color: var(--primary-color);
}

/* Form Styling */
.config-form {
  display: flex;
  flex-direction: column;
  gap: 1.25rem;
}

.form-group {
  display: flex;
  flex-direction: column;
  gap: 0.6rem;
  position: relative; /* For custom select arrow */
}

.form-group label {
  font-weight: 600;
  font-size: 0.95rem;
  color: var(--dark-gray);
}

.input-field {
  width: 100%;
  padding: 10px 14px;
  border: 1px solid var(--border-color);
  border-radius: var(--border-radius-md);
  box-sizing: border-box;
  font-size: 1rem;
  background-color: #fff;
  transition: border-color 0.2s, box-shadow 0.2s;
}
.input-field:focus {
  border-color: var(--primary-color);
  box-shadow: 0 0 0 3px rgba(var(--primary-color-rgb, 33, 150, 243), 0.2);
  outline: none;
}

.help-text {
  font-size: 0.85rem;
  color: var(--dark-gray);
  margin-top: 0.25rem;
}

/* Custom Select Dropdown */
.custom-select-wrapper {
  position: relative;
}

.custom-select-wrapper select {
  -webkit-appearance: none;
  -moz-appearance: none;
  appearance: none;
  padding-right: 2.5rem; /* Make space for custom arrow */
}

.custom-select-arrow {
  position: absolute;
  right: 14px;
  top: 50%;
  transform: translateY(-50%) rotate(45deg);
  width: 8px;
  height: 8px;
  border-right: 2px solid var(--dark-gray);
  border-bottom: 2px solid var(--dark-gray);
  pointer-events: none;
}

/* File Upload Component */
.file-upload-group {
  margin-bottom: 1rem;
}

.file-upload-label {
  display: flex;
  align-items: center;
  justify-content: space-between;
  cursor: pointer;
  padding: 12px 16px;
  border: 2px dashed var(--border-color);
  border-radius: var(--border-radius-md);
  background-color: var(--light-gray);
  transition: border-color 0.2s, background-color 0.2s;
}
.file-upload-label:hover {
  border-color: var(--primary-color);
  background-color: #e3f2fd;
}

.file-upload-label strong {
  color: var(--dark-gray);
  font-weight: normal;
}

.file-upload-btn {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  background-color: var(--primary-color);
  color: white;
  padding: 8px 12px;
  border-radius: var(--border-radius-sm);
  font-size: 0.9rem;
  font-weight: 500;
  transition: background-color 0.2s;
}
.file-upload-btn:hover {
  background-color: #1976D2;
}

.hidden-file-input {
  display: none;
}

.file-info {
  display: flex;
  align-items: center;
  gap: 0.75rem;
  background-color: #e0f2f1; /* Light green */
  border: 1px solid #c8e6c9;
  padding: 8px 12px;
  border-radius: var(--border-radius-md);
  margin-top: 0.5rem;
  font-size: 0.9rem;
}
.file-icon {
  color: var(--secondary-color);
  font-size: 1.2rem;
}
.remove-file-icon {
  color: var(--error-color);
  cursor: pointer;
  margin-left: auto;
  font-size: 1rem;
  transition: opacity 0.2s;
}
.remove-file-icon:hover {
  opacity: 0.7;
}

/* Buttons */
.btn {
  padding: 12px 18px;
  border: none;
  border-radius: var(--border-radius-md);
  font-size: 1rem;
  font-weight: 600;
  cursor: pointer;
  transition: background-color 0.2s, box-shadow 0.2s;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 0.75rem;
}

.btn-primary {
  background-color: var(--primary-color);
  color: white;
}
.btn-primary:hover:not(:disabled) {
  background-color: #1976D2;
  box-shadow: var(--shadow-sm);
}
.btn-secondary {
  background-color: #6c757d;
  color: white;
}
.btn-secondary:hover:not(:disabled) {
  background-color: #5a6268;
  box-shadow: var(--shadow-sm);
}
.btn:disabled {
  background-color: var(--medium-gray);
  color: var(--dark-gray);
  cursor: not-allowed;
}

.download-section {
  margin-top: 2rem;
  padding-top: 1.5rem;
  border-top: 1px solid var(--border-color);
  text-align: center;
}

/* Status Messages */
.status-message {
  padding: 2rem;
  border-radius: var(--border-radius-md);
  text-align: center;
  margin-top: 1.5rem;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 1rem;
}

.status-message.loading {
  background-color: #e3f2fd; /* Light blue */
  border: 1px solid #bbdefb;
  color: #1976D2;
}

.status-message.error {
  background-color: #ffebee; /* Light red */
  border: 1px solid #ef9a9a;
  color: var(--error-color);
}
.status-message.error h3 {
  color: var(--error-color);
}

.status-message.empty-state {
  background-color: #ffffff;
  border: 1px dashed var(--border-color);
  color: var(--dark-gray);
}

.status-icon {
  font-size: 3rem;
  margin-bottom: 0.5rem;
}
.status-message.error .status-icon {
  color: var(--error-color);
}
.status-message.empty-state .status-icon {
  color: var(--medium-gray);
}


/* Results Container */
.results-container {
  margin-top: 1.5rem;
}

.results-summary {
  font-size: 1.2rem;
  margin-bottom: 1.5rem;
  color: #1a202c;
  display: flex;
  align-items: center;
  gap: 0.75rem;
}
.icon-success {
  color: var(--secondary-color);
}


/* Finding Card Styles */
.finding-card {
  background: #fff;
  border: 1px solid var(--border-color);
  border-radius: var(--border-radius-md);
  box-shadow: var(--shadow-sm);
  margin-bottom: 1.5rem;
  overflow: hidden;
  transition: transform 0.2s;
}

.finding-card:hover {
  transform: translateY(-2px);
  box-shadow: var(--shadow-md);
}

.card-header {
  padding: 0.75rem 1.25rem;
  background-color: var(--light-gray);
  border-bottom: 1px solid var(--border-color);
  display: flex;
  justify-content: space-between;
  align-items: center;
  font-size: 0.9rem;
}

.card-badge {
  background-color: var(--accent-color);
  color: #333;
  padding: 4px 8px;
  border-radius: var(--border-radius-sm);
  font-weight: 600;
}

.card-page {
  font-weight: 500;
  color: var(--dark-gray);
}

.card-section {
  padding: 1.25rem;
  border-bottom: 1px solid var(--medium-gray);
}

.finding-card:last-child .card-section {
  border-bottom: none;
}

.card-section h4 {
  font-size: 1.05rem;
  margin-bottom: 0.75rem;
  color: #1a202c;
}

.text-pair {
  display: grid;
  grid-template-columns: 1fr; /* Stack on mobile */
  gap: 1rem;
}

@media (min-width: 600px) { /* Two columns on larger screens */
  .text-pair {
    grid-template-columns: 1fr 1fr;
    gap: 1.5rem;
  }
}

.text-block {
  background-color: var(--light-gray);
  border: 1px solid var(--border-color);
  border-radius: var(--border-radius-md);
  padding: 1rem;
}

.text-block strong {
  display: block;
  margin-bottom: 0.5rem;
  color: var(--dark-gray);
}

blockquote {
  margin: 0;
  padding: 0;
  color: #555;
  font-style: italic;
  font-size: 0.95rem;
}

.suggestion-section {
  background-color: #e8f5e9; /* Light green for suggestions */
  border-top: 1px solid #d0e9d1;
}
.suggestion-section strong {
  color: var(--secondary-color);
  font-weight: 600;
}


/* Highlighted Text */
.highlight-error {
  background-color: #ffebee; /* Light red */
  color: var(--error-color);
  padding: 2px 5px;
  border-radius: var(--border-radius-sm);
  display: inline; /* To not break text flow */
}
.highlight-warning {
  background-color: #fffde7; /* Light yellow */
  color: #f57f17; /* Darker yellow */
  padding: 2px 5px;
  border-radius: var(--border-radius-sm);
  display: inline;
}
